# Правила развертывания и стабильности (Deployment Rules)

Этот документ описывает основные причины возникновения ошибок 404, 500+ и сбоев деплоя, а также правила для их предотвращения.

---

## 1. Ошибки Деплоя (Exit Code 255 / SSH Disconnect)
**Симптом:** Деплой прерывается с ошибкой `SSH connection failed`, `Connection reset by peer` или `exit code 255`.
**Причина:** Нехватка оперативной памяти (OOM - Out Of Memory) на сервере во время сборки. Сборка Frontend (SvelteKit) и установка Python-зависимостей требуют значительных ресурсов.

### ✅ Правило 1: Обязательный SWAP
Убедитесь, что на вашем VPS активирован **SWAP-файл** (файл подкачки). Для стабильной сборки рекомендуется **минимум 4GB** swap.
*   **Проверка:** Выполните `free -h` в терминале сервера. Если в строке Swap одни нули, сборка будет падать регулярно.
*   **Решение:** Добавьте swap, если его нет.

### ✅ Правило 2: Чистый старт
Если деплой завис или упал, может остаться "зомби" процесс. Перед повторным деплоем желательно перезагрузить сервер или проверить загрузку CPU/RAM.

---

## 2. Ошибки 404 (Not Found)
**Симптом:** При открытии новых страниц (например, `/ru`, `/auth`) возникает 404, хотя файлы существуют.
**Причина:** SvelteKit (Frontend) генерирует карту маршрутов (manifest) **только во время сборки (Build)**.

### ✅ Правило 3: Full Rebuild при новых маршрутах
Если вы добавили новую папку в `src/routes/` или изменили конфигурацию `svelte.config.js`:
1.  Недостаточно просто "перезапустить" контейнер.
2.  Необходимо выполнить **полную пересборку (Rebuild / Redeploy with Build)** в Coolify.
3.  Только тогда создадутся новые HTML-файлы и JS-чанки.

---

## 3. Ошибки 502 / 504 (Bad Gateway / Timeout)
**Симптом:** "nginx 502 Bad Gateway" или "504 Gateway Time-out".
**Причина:** Бэкенд (Python/Go) или Фронтенд (Node) еще не запустились, упали или отвечают слишком долго.

### ✅ Правило 4: Ожидание старта (Warming Up)
После деплоя приложению нужно 30-60 секунд на старт:
*   Python сервис загружает ML модели в память.
*   Node.js сервис поднимает сервер.
*   **Действие:** Если видите 502 сразу после деплоя — подождите 1 минуту.

### ✅ Правило 5: Таймауты в Nginx
Транскрибация длинных файлов длится долго. Стандартный таймаут Nginx (60 сек) обрывает соединение.
*   Убедитесь, что в `nginx.conf` установлены увеличенные таймауты:
    ```nginx
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
    ```
*   Текущая конфигурация в проекте это уже учитывает, **не удаляйте** эти строки при правках конфига.

---

## 4. Чек-лист перед коммитом/деплоем
Чтобы избежать проблем, проверяйте этот список:

1.  [ ] **`svelte.config.js`**: Если меняли адаптер или препроцессоры — нужен Rebuild.
2.  [ ] **`+page.svelte` / `+layout.svelte`**: Проверили локально (`npm run dev`), что нет ошибок компиляции? Ошибки JS ломают билд.
3.  [ ] **`routes/`**: Добавили новую папку? --> **Rebuild**.
4.  [ ] **Сервер**: Есть свободная память? (`free -h`).
